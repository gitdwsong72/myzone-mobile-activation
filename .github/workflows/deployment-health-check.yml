name: Deployment Health Check

on:
  workflow_run:
    workflows: ["Deploy to GitHub Pages"]
    types:
      - completed

jobs:
  health-check:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
    - name: Wait for GitHub Pages deployment
      run: |
        echo "â³ Waiting for GitHub Pages to update..."
        sleep 60  # GitHub Pages ë°°í¬ ì™„ë£Œ ëŒ€ê¸°
    
    - name: Health Check
      run: |
        REPO_NAME="${{ github.repository }}"
        REPO_OWNER="${{ github.repository_owner }}"
        SITE_URL="https://${REPO_OWNER}.github.io/${REPO_NAME##*/}"
        APP_URL="$SITE_URL/app"
        
        echo "ğŸ¥ Starting health check..."
        echo "ğŸŒ Site URL: $SITE_URL"
        echo "ğŸ“± App URL: $APP_URL"
        
        # ê¸°ë³¸ ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸
        check_url() {
          local url=$1
          local name=$2
          
          if curl -s -f -o /dev/null "$url"; then
            echo "âœ… $name is accessible"
            return 0
          else
            echo "âŒ $name is not accessible"
            return 1
          fi
        }
        
        # ìƒíƒœ í™•ì¸
        LANDING_OK=false
        APP_OK=false
        
        if check_url "$SITE_URL" "Landing Page"; then
          LANDING_OK=true
        fi
        
        if check_url "$APP_URL" "React App"; then
          APP_OK=true
        fi
        
        # ê²°ê³¼ ìš”ì•½
        echo ""
        echo "ğŸ“Š Health Check Results:"
        echo "  Landing Page: $([ "$LANDING_OK" = true ] && echo "âœ… OK" || echo "âŒ FAIL")"
        echo "  React App: $([ "$APP_OK" = true ] && echo "âœ… OK" || echo "âŒ FAIL")"
        
        if [ "$LANDING_OK" = true ] && [ "$APP_OK" = true ]; then
          echo ""
          echo "ğŸ‰ All services are healthy!"
          echo "ğŸš€ Deployment successful and verified"
        else
          echo ""
          echo "âš ï¸ Some services may need time to propagate"
          echo "ğŸ”„ GitHub Pages can take a few minutes to update"
        fi

  notify-failure:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    
    steps:
    - name: Deployment Failed Notification
      run: |
        echo "âŒ GitHub Pages deployment failed!"
        echo ""
        echo "ğŸ” Troubleshooting steps:"
        echo "1. Check the deployment workflow logs"
        echo "2. Verify React build is successful locally"
        echo "3. Check GitHub Pages settings in repository"
        echo "4. Ensure all required secrets are configured"
        echo ""
        echo "ğŸ“‹ Quick fixes:"
        echo "- Run 'npm run build:minimal' locally to test build"
        echo "- Check for TypeScript or dependency errors"
        echo "- Verify environment variables are set correctly"