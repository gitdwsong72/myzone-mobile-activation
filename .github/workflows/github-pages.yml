name: Deploy to GitHub Pages

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'frontend/**'
      - 'docs/**'
      - '.github/workflows/github-pages.yml'

permissions:
  contents: write
  pages: write
  id-token: write

env:
  NODE_VERSION: '18'
  CACHE_VERSION: v1

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Setup Node.js with enhanced caching
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Cache node_modules
      uses: actions/cache@v3
      id: cache-node-modules
      with:
        path: frontend/node_modules
        key: ${{ env.CACHE_VERSION }}-node-modules-${{ runner.os }}-${{ hashFiles('frontend/package-lock.json') }}
        restore-keys: |
          ${{ env.CACHE_VERSION }}-node-modules-${{ runner.os }}-
    
    - name: Install dependencies
      if: steps.cache-node-modules.outputs.cache-hit != 'true'
      run: |
        cd frontend
        npm ci --prefer-offline --no-audit
    
    - name: Verify dependencies
      run: |
        cd frontend
        npm ls --depth=0 || echo "Some peer dependencies missing, but build should work"
    
    - name: Build React App
      env:
        REACT_APP_API_URL: https://myzone-backend-production.up.railway.app/api/v1
        PUBLIC_URL: /myzone-mobile-activation/app
        GENERATE_SOURCEMAP: false
        REACT_APP_ENVIRONMENT: demo
        REACT_APP_DEMO_MODE: true
        CI: false
        DISABLE_ESLINT_PLUGIN: true
        TSC_COMPILE_ON_ERROR: true
        ESLINT_NO_DEV_ERRORS: true
        SKIP_PREFLIGHT_CHECK: true
        TYPESCRIPT_COMPILE_ON_ERROR: true
        NODE_OPTIONS: '--max-old-space-size=4096'
      run: |
        cd frontend
        echo "ğŸš€ Starting React build..."
        npm run build:minimal
        echo "âœ… Build completed successfully"
        echo "ğŸ“¦ Build size: $(du -sh build | cut -f1)"
    
    - name: Validate build output
      run: |
        cd frontend
        if [ ! -d "build" ]; then
          echo "âŒ Build directory not found!"
          exit 1
        fi
        
        if [ ! -f "build/index.html" ]; then
          echo "âŒ index.html not found in build!"
          exit 1
        fi
        
        if [ ! -f "build/404.html" ]; then
          echo "âŒ 404.html not found in build!"
          exit 1
        fi
        
        echo "âœ… Build validation passed"
        echo "ğŸ“ Build contents:"
        ls -la build/
    
    - name: Prepare deployment structure
      run: |
        echo "ğŸ”§ Preparing deployment structure..."
        
        # ê¸°ì¡´ docs ë°±ì—… (ëœë”© í˜ì´ì§€ ë³´ì¡´)
        if [ -f docs/index.html ]; then
          echo "ğŸ“„ Backing up existing landing page..."
          cp docs/index.html docs/landing.html
        fi
        
        # React ì•±ì„ docs/appì— ë°°ì¹˜
        echo "ğŸ“± Deploying React app to /app subdirectory..."
        mkdir -p docs/app
        cp -r frontend/build/* docs/app/
        
        # ëœë”© í˜ì´ì§€ ë³µì›
        if [ -f docs/landing.html ]; then
          echo "ğŸ  Restoring landing page..."
          cp docs/landing.html docs/index.html
          rm docs/landing.html
        fi
        
        # SPA ë¼ìš°íŒ…ì„ ìœ„í•œ 404.htmlì„ ë£¨íŠ¸ì— ë°°ì¹˜
        echo "ğŸ”€ Setting up SPA routing..."
        cp frontend/build/404.html docs/404.html
        
        echo "âœ… Deployment structure ready"
        echo "ğŸ“ Final structure:"
        find docs -type f -name "*.html" | head -10
    
    - name: Commit and push to docs
      run: |
        echo "ğŸ“ Committing deployment files..."
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # docs í´ë” ë³€ê²½ì‚¬í•­ ì¶”ê°€
        git add docs/
        
        # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
        if git diff --staged --quiet; then
          echo "ğŸ“„ No changes to deploy"
        else
          git commit -m "ğŸš€ Deploy: $(date '+%Y-%m-%d %H:%M:%S')"
          git push origin main
          echo "âœ… Deployment committed and pushed"
        fi
    
    - name: Analyze bundle size and performance
      run: |
        cd frontend
        echo "ğŸ“¦ Analyzing bundle size and performance..."
        
        # ì„±ëŠ¥ ë¶„ì„ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        npm run analyze:performance || echo "Performance analysis completed with warnings"
        
        # ê¸°ë³¸ í¬ê¸° ë¶„ì„ (ë°±ì—…ìš©)
        BUILD_SIZE=$(du -sh build | cut -f1)
        JS_SIZE=$(du -sh build/static/js 2>/dev/null | cut -f1 || echo "0")
        CSS_SIZE=$(du -sh build/static/css 2>/dev/null | cut -f1 || echo "0")
        
        echo "ğŸ“Š Quick Bundle Analysis:"
        echo "  - Total build size: $BUILD_SIZE"
        echo "  - JavaScript size: $JS_SIZE"
        echo "  - CSS size: $CSS_SIZE"
        
        # ì„±ëŠ¥ ë¶„ì„ ê²°ê³¼ í™•ì¸
        if [ -f "build/performance-analysis.json" ]; then
          echo "âœ… Performance analysis report generated"
          
          # JSONì—ì„œ ì ìˆ˜ ì¶”ì¶œ (jqê°€ ìˆëŠ” ê²½ìš°)
          if command -v jq >/dev/null 2>&1; then
            SCORE=$(jq -r '.score' build/performance-analysis.json)
            GRADE=$(jq -r '.grade' build/performance-analysis.json)
            echo "ğŸ† Performance Score: $SCORE/100 (Grade: $GRADE)"
          fi
        else
          echo "âš ï¸ Performance analysis report not found"
        fi
        
        # í° íŒŒì¼ ì‹ë³„
        echo "ğŸ“‹ Largest files:"
        find build -type f -name "*.js" -o -name "*.css" | xargs ls -lh | sort -k5 -hr | head -5

    - name: Verify deployment
      run: |
        echo "ğŸ” Verifying deployment..."
        sleep 30  # GitHub Pages ë°°í¬ ëŒ€ê¸°
        
        # ê¸°ë³¸ ì ‘ê·¼ì„± í™•ì¸
        REPO_NAME="${{ github.repository }}"
        REPO_OWNER="${{ github.repository_owner }}"
        SITE_URL="https://${REPO_OWNER}.github.io/${REPO_NAME##*/}"
        
        echo "ğŸŒ Site URL: $SITE_URL"
        echo "ğŸ“± React App URL: $SITE_URL/app"
        
        # HTTP ìƒíƒœ í™•ì¸
        if command -v curl >/dev/null 2>&1; then
          echo "ğŸ“¡ Checking site accessibility..."
          
          # ëœë”© í˜ì´ì§€ í™•ì¸
          LANDING_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$SITE_URL" || echo "000")
          if [ "$LANDING_STATUS" = "200" ]; then
            echo "âœ… Landing page is accessible (HTTP $LANDING_STATUS)"
          else
            echo "âš ï¸ Landing page returned HTTP $LANDING_STATUS"
          fi
          
          # React ì•± í™•ì¸
          APP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$SITE_URL/app" || echo "000")
          if [ "$APP_STATUS" = "200" ]; then
            echo "âœ… React app is accessible (HTTP $APP_STATUS)"
          else
            echo "âš ï¸ React app returned HTTP $APP_STATUS"
          fi
          
          # ì„±ëŠ¥ ì¸¡ì •
          echo "â±ï¸ Performance check:"
          RESPONSE_TIME=$(curl -s -o /dev/null -w "%{time_total}" "$SITE_URL" || echo "0")
          echo "  - Landing page response time: ${RESPONSE_TIME}s"
          
          APP_RESPONSE_TIME=$(curl -s -o /dev/null -w "%{time_total}" "$SITE_URL/app" || echo "0")
          echo "  - React app response time: ${APP_RESPONSE_TIME}s"
        fi
        
        echo "ğŸ‰ Deployment completed successfully!"
        echo "ğŸ“‹ Summary:"
        echo "  - Landing Page: $SITE_URL (HTTP $LANDING_STATUS)"
        echo "  - React App: $SITE_URL/app (HTTP $APP_STATUS)"
        echo "  - SPA Routing: Enabled with 404.html"

    - name: Create deployment report
      run: |
        echo "ğŸ“ Creating deployment report..."
        
        REPO_NAME="${{ github.repository }}"
        REPO_OWNER="${{ github.repository_owner }}"
        SITE_URL="https://${REPO_OWNER}.github.io/${REPO_NAME##*/}"
        TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S UTC')
        COMMIT_SHA="${{ github.sha }}"
        
        # ë¹Œë“œ ì •ë³´ ìˆ˜ì§‘
        cd frontend
        BUILD_SIZE=$(du -sh build | cut -f1)
        JS_COUNT=$(find build/static/js -name "*.js" 2>/dev/null | wc -l || echo "0")
        CSS_COUNT=$(find build/static/css -name "*.css" 2>/dev/null | wc -l || echo "0")
        
        # ë¦¬í¬íŠ¸ ìƒì„±
        cat > ../docs/deployment-status.html << EOF
        <!DOCTYPE html>
        <html lang="ko">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ë°°í¬ ìƒíƒœ - MyZone</title>
            <style>
                body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 40px; }
                .status { padding: 20px; border-radius: 8px; margin: 20px 0; }
                .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
                .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
                .metric { display: inline-block; margin: 10px 20px 10px 0; }
                .metric strong { display: block; font-size: 1.2em; }
            </style>
        </head>
        <body>
            <h1>ğŸš€ MyZone ë°°í¬ ìƒíƒœ</h1>
            
            <div class="status success">
                <h2>âœ… ë°°í¬ ì„±ê³µ</h2>
                <p><strong>ë°°í¬ ì‹œê°„:</strong> $TIMESTAMP</p>
                <p><strong>ì»¤ë°‹:</strong> $COMMIT_SHA</p>
                <p><strong>ì›Œí¬í”Œë¡œìš°:</strong> ${{ github.workflow }}</p>
            </div>
            
            <div class="status info">
                <h2>ğŸ“Š ë¹Œë“œ ì •ë³´</h2>
                <div class="metric">
                    <strong>$BUILD_SIZE</strong>
                    <span>ì´ ë¹Œë“œ í¬ê¸°</span>
                </div>
                <div class="metric">
                    <strong>$JS_COUNT</strong>
                    <span>JavaScript íŒŒì¼</span>
                </div>
                <div class="metric">
                    <strong>$CSS_COUNT</strong>
                    <span>CSS íŒŒì¼</span>
                </div>
            </div>
            
            <div class="status info">
                <h2>ğŸ”— ì ‘ì† ë§í¬</h2>
                <p><a href="$SITE_URL" target="_blank">ğŸ  ëœë”© í˜ì´ì§€</a></p>
                <p><a href="$SITE_URL/app" target="_blank">ğŸ“± React ì•±</a></p>
            </div>
            
            <div class="status info">
                <h2>ğŸ“ˆ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§</h2>
                <p>ë°°í¬ëœ ì•±ì—ì„œ ì„±ëŠ¥ ë°ì´í„°ë¥¼ í™•ì¸í•˜ë ¤ë©´ ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬ì˜ ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.</p>
                <p>ë²ˆë“¤ ë¶„ì„ì„ ìœ„í•´ <code>npm run analyze</code> ëª…ë ¹ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
        </body>
        </html>
        EOF
        
        echo "âœ… Deployment report created at docs/deployment-status.html"
    
    - name: Create failure report
      if: failure()
      run: |
        echo "âŒ Deployment failed!"
        
        TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S UTC')
        COMMIT_SHA="${{ github.sha }}"
        
        # ì‹¤íŒ¨ ë¦¬í¬íŠ¸ ìƒì„±
        mkdir -p docs
        cat > docs/deployment-status.html << EOF
        <!DOCTYPE html>
        <html lang="ko">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ë°°í¬ ì‹¤íŒ¨ - MyZone</title>
            <style>
                body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 40px; }
                .status { padding: 20px; border-radius: 8px; margin: 20px 0; }
                .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
                .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
            </style>
        </head>
        <body>
            <h1>âŒ MyZone ë°°í¬ ì‹¤íŒ¨</h1>
            
            <div class="status error">
                <h2>ë°°í¬ ì‹¤íŒ¨</h2>
                <p><strong>ì‹¤íŒ¨ ì‹œê°„:</strong> $TIMESTAMP</p>
                <p><strong>ì»¤ë°‹:</strong> $COMMIT_SHA</p>
                <p><strong>ì›Œí¬í”Œë¡œìš°:</strong> ${{ github.workflow }}</p>
            </div>
            
            <div class="status info">
                <h2>ğŸ” ë¬¸ì œ í•´ê²° ê°€ì´ë“œ</h2>
                <ul>
                    <li>GitHub Actions ë¡œê·¸ì—ì„œ ìƒì„¸í•œ ì˜¤ë¥˜ ë©”ì‹œì§€ í™•ì¸</li>
                    <li>React ì•± ë¹Œë“œ ì˜¤ë¥˜ í™•ì¸</li>
                    <li>í™˜ê²½ ë³€ìˆ˜ ì„¤ì • í™•ì¸</li>
                    <li>GitHub Pages ì„¤ì • í™•ì¸</li>
                    <li>ì˜ì¡´ì„± ë²„ì „ ì¶©ëŒ í™•ì¸</li>
                </ul>
            </div>
            
            <div class="status info">
                <h2>ğŸ“ ì§€ì›</h2>
                <p>ë¬¸ì œê°€ ì§€ì†ë˜ë©´ GitHub Issuesì—ì„œ ë„ì›€ì„ ìš”ì²­í•˜ì„¸ìš”.</p>
            </div>
        </body>
        </html>
        EOF
        
        echo "ğŸ“ Failure report created"
        echo "ğŸ” Check the logs above for details"
        echo "ğŸ’¡ Common issues:"
        echo "  - Build errors in React app"
        echo "  - Missing environment variables"  
        echo "  - GitHub Pages configuration issues"
        echo "  - Node.js memory issues"
        echo "  - Dependency conflicts"

    - name: Notify on failure
      if: failure()
      run: |
        echo "ğŸš¨ Deployment monitoring alert:"
        echo "  - Status: FAILED"
        echo "  - Time: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo "  - Commit: ${{ github.sha }}"
        echo "  - Branch: ${{ github.ref_name }}"
        echo "  - Actor: ${{ github.actor }}"